# Remote Manifest v2 - Enhanced with Full Adapter/Action Metadata
# Demonstrates all Stage 4 schema enhancements

source: oneiric-production-v2
signature: "base64-encoded-ed25519-signature-placeholder"
signature_algorithm: ed25519

# Serverless profile note:
#   - Inline this manifest when building Cloud Run images
#   - Launch via Procfile entry `web: uv run python -m oneiric.cli orchestrate --profile serverless --no-remote`
#   - Keep `remote_refresh` disabled by default for the serverless profile

entries:
  # ==============================================================================
  # ADAPTER EXAMPLES - Full metadata with all Stage 4 fields
  # ==============================================================================

  # Redis Cache Adapter - Production example with all metadata
  - domain: adapter
    key: cache
    provider: redis
    factory: oneiric.adapters.cache.redis:RedisCacheAdapter
    uri: https://cdn.oneiric.dev/releases/v1.0.0/redis-cache.whl
    sha256: abc123def456789abc123def456789abc123def456789abc123def456789abc1
    stack_level: 50
    priority: 500
    version: "1.0.0"

    # Adapter-specific metadata
    capabilities: ["kv", "ttl", "tracking", "pub-sub"]
    owner: "Platform Core Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.cache.redis:RedisSettings"

    # Dependencies
    requires:
      - "redis>=5.0.0"
      - "coredis>=4.0.0"

    # Platform constraints
    python_version: ">=3.13"
    os_platform: ["linux", "darwin"]

    # Documentation
    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/adapters/cache/redis"

    # Generic metadata
    metadata:
      description: "Production Redis cache with client-side tracking and pub-sub"
      health_check_timeout: 5.0
      connection_pool_size: 10
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false
        procfile_entry: "web: uv run python -m oneiric.cli orchestrate --profile serverless --no-remote"
      max_connections: 50

  # PostgreSQL Database Adapter - Full example
  - domain: adapter
    key: database
    provider: postgres
    factory: oneiric.adapters.database.postgres:PostgresAdapter
    stack_level: 40
    priority: 400
    version: "1.0.0"

    capabilities: ["sql", "transactions", "async-pool", "migrations"]
    owner: "Data Platform Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.database.postgres:PostgresSettings"

    requires:
      - "asyncpg>=0.29.0"

    python_version: ">=3.13"
    os_platform: ["linux", "darwin", "windows"]

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/adapters/database/postgres"

    metadata:
      description: "PostgreSQL adapter with async connection pooling"
      pool_min_size: 5
      pool_max_size: 20

  # S3 Storage Adapter - Cloud storage example
  - domain: adapter
    key: storage
    provider: s3
    factory: oneiric.adapters.storage.s3:S3StorageAdapter
    stack_level: 30
    version: "1.0.0"

    capabilities: ["object-storage", "multipart-upload", "presigned-urls"]
    owner: "Data Platform Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.storage.s3:S3Settings"

    requires:
      - "aioboto3>=12.0.0"
      - "boto3>=1.34.0"

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/adapters/storage/s3"

    metadata:
      description: "AWS S3 storage adapter with multipart upload support"
      max_concurrent_uploads: 10

  # Auth0 Identity Adapter - Authentication example
  - domain: adapter
    key: identity
    provider: auth0
    factory: oneiric.adapters.identity.auth0:Auth0Adapter
    stack_level: 40
    version: "1.0.0"

    capabilities: ["jwt-validation", "jwks-caching", "user-info"]
    owner: "Security Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.identity.auth0:Auth0Settings"

    requires:
      - "httpx>=0.27.0"
      - "python-jose[cryptography]>=3.3.0"

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/adapters/identity/auth0"

    metadata:
      description: "Auth0 JWT validation with JWKS caching"
      jwks_cache_ttl: 3600

  # SendGrid Messaging Adapter - Email delivery
  - domain: adapter
    key: messaging.email
    provider: sendgrid
    factory: oneiric.adapters.messaging.sendgrid:SendGridAdapter
    stack_level: 20
    priority: 320
    version: "1.0.0"

    capabilities: ["email", "transactional", "sandbox-mode"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.messaging.sendgrid:SendGridSettings"

    requires:
      - "email-validator>=2.2.0"

    metadata:
      description: "SendGrid transactional email adapter (sandbox by default)"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false
        procfile_entry: "web: uv run python -m oneiric.cli orchestrate --profile serverless --no-remote"

  # Mailgun Messaging Adapter
  - domain: adapter
    key: messaging.email.mailgun
    provider: mailgun
    factory: oneiric.adapters.messaging.mailgun:MailgunAdapter
    stack_level: 20
    priority: 325
    version: "1.0.0"

    capabilities: ["email", "sandbox-mode", "custom-args"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.messaging.mailgun:MailgunSettings"

    metadata:
      description: "Mailgun email adapter with sandbox/test mode defaults"
      test_mode: true
      tags: ["demo"]
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Twilio SMS Adapter
  - domain: adapter
    key: messaging.sms
    provider: twilio
    factory: oneiric.adapters.messaging.twilio:TwilioAdapter
    stack_level: 20
    priority: 330
    version: "1.0.0"

    capabilities: ["sms", "notifications", "dry-run"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.messaging.twilio:TwilioSettings"

    metadata:
      description: "Twilio SMS adapter with dry-run + webhook signature helpers"
      dry_run: true
      serverless:
        profile: serverless
        remote_refresh_enabled: false
      watchers_enabled: false

  # SCP File Transfer Adapter
  - domain: adapter
    key: file_transfer.scp
    provider: scp
    factory: oneiric.adapters.file_transfer.scp:SCPFileTransferAdapter
    stack_level: 15
    priority: 340

    capabilities: ["upload", "download", "delete", "list"]
    owner: "Infra Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.file_transfer.scp:SCPFileTransferSettings"

    metadata:
      description: "SSH-based file transfer adapter used when FTP servers are unavailable"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # HTTPS Upload Adapter
  - domain: adapter
    key: file_transfer.https_upload
    provider: https-upload
    factory: oneiric.adapters.file_transfer.http_upload:HTTPSUploadAdapter
    stack_level: 15
    priority: 335

    capabilities: ["upload"]
    owner: "Platform Core"
    requires_secrets: false
    settings_model: "oneiric.adapters.file_transfer.http_upload:HTTPSUploadSettings"

    metadata:
      description: "httpx-powered HTTPS uploader for signed artifact pushes"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # MongoDB NoSQL Adapter
  - domain: adapter
    key: nosql.primary
    provider: mongodb
    factory: oneiric.adapters.nosql.mongodb:MongoDBAdapter
    stack_level: 25
    priority: 340
    version: "1.0.0"

    capabilities: ["documents", "aggregation", "filtering"]
    owner: "Data Platform Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.nosql.mongodb:MongoDBSettings"

    requires:
      - "motor>=3.6.0"

    metadata:
      description: "MongoDB document store for workflow state + audit trails"
      default_collection: "workflow_state"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # DynamoDB NoSQL Adapter
  - domain: adapter
    key: nosql.secondary
    provider: dynamodb
    factory: oneiric.adapters.nosql.dynamodb:DynamoDBAdapter
    stack_level: 25
    priority: 345
    version: "1.0.0"

    capabilities: ["documents", "key-value", "scan", "conditional_writes"]
    owner: "Data Platform Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.nosql.dynamodb:DynamoDBSettings"

    requires:
      - "aioboto3>=15.5.0"

    metadata:
      description: "DynamoDB table for workflow state (useful for AWS-first runtimes)"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Firestore NoSQL Adapter
  - domain: adapter
    key: nosql.firestore
    provider: firestore
    factory: oneiric.adapters.nosql.firestore:FirestoreAdapter
    stack_level: 25
    priority: 345
    version: "1.0.0"

    capabilities: ["documents", "query", "serverless"]
    owner: "Data Platform Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.nosql.firestore:FirestoreSettings"

    requires:
      - "google-cloud-firestore>=2.16.0"

    metadata:
      description: "Firestore collection for workflow state (Cloud Run friendly)"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Cloud Tasks Queue Adapter
  - domain: adapter
    key: queue.scheduler
    provider: cloudtasks
    factory: oneiric.adapters.queue.cloudtasks:CloudTasksQueueAdapter
    stack_level: 30
    priority: 380
    version: "1.0.0"

    capabilities: ["queue", "scheduler", "serverless"]
    owner: "Platform Core Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.queue.cloudtasks:CloudTasksQueueSettings"

    metadata:
      description: "Cloud Tasks adapter for DAG triggers"
      http_target_url: "https://example.com/hooks/dag"
      service_account_email: "tasks@project.iam.gserviceaccount.com"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Pub/Sub Queue Adapter
  - domain: adapter
    key: queue.events
    provider: pubsub
    factory: oneiric.adapters.queue.pubsub:PubSubQueueAdapter
    stack_level: 30
    priority: 385
    version: "1.0.0"

    capabilities: ["queue", "pubsub", "events"]
    owner: "Platform Core Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.queue.pubsub:PubSubQueueSettings"

    metadata:
      description: "Pub/Sub topic/subscription used for DAG/event fan-out"
      topic: "workflow-start"
      subscription: "workflow-start-workers"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Kafka Queue Adapter
  - domain: adapter
    key: queue.kafka
    provider: kafka
    factory: oneiric.adapters.queue.kafka:KafkaQueueAdapter
    stack_level: 30
    priority: 360
    version: "1.0.0"

    capabilities: ["queue", "streaming"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.queue.kafka:KafkaQueueSettings"

    requires:
      - "aiokafka>=0.10.0"

    metadata:
      description: "Kafka topic for streaming workflow triggers"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # RabbitMQ Queue Adapter
  - domain: adapter
    key: queue.rabbitmq
    provider: rabbitmq
    factory: oneiric.adapters.queue.rabbitmq:RabbitMQQueueAdapter
    stack_level: 30
    priority: 365
    version: "1.0.0"

    capabilities: ["queue"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.queue.rabbitmq:RabbitMQQueueSettings"

    requires:
      - "aio-pika>=9.4.0"

    metadata:
      description: "RabbitMQ queue for AWS/on-prem orchestrations"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Slack Notifications Adapter
  - domain: adapter
    key: notifications.slack
    provider: slack
    factory: oneiric.adapters.messaging.slack:SlackAdapter
    stack_level: 20
    priority: 360
    version: "1.0.0"

    capabilities: ["notifications", "chatops"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.messaging.slack:SlackSettings"

    metadata:
      description: "Slack chat.postMessage adapter"
      default_channel: "#platform-alerts"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Teams Notifications Adapter
  - domain: adapter
    key: notifications.teams
    provider: teams
    factory: oneiric.adapters.messaging.teams:TeamsAdapter
    stack_level: 20
    priority: 365
    version: "1.0.0"

    capabilities: ["notifications", "chatops"]
    owner: "Messaging Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.messaging.teams:TeamsSettings"

    metadata:
      description: "Microsoft Teams incoming webhook adapter"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Generic Webhook Adapter
  - domain: adapter
    key: notifications.webhook
    provider: webhook
    factory: oneiric.adapters.messaging.webhook:WebhookAdapter
    stack_level: 20
    priority: 368
    version: "1.0.0"

    capabilities: ["notifications", "webhook"]
    owner: "Messaging Team"
    requires_secrets: false
    settings_model: "oneiric.adapters.messaging.webhook:WebhookSettings"

    metadata:
      description: "Generic JSON webhook adapter"
      serverless:
        profile: serverless
        remote_refresh_enabled: false
        watchers_enabled: false

  # Sentry Monitoring Adapter - Observability example
  - domain: adapter
    key: monitoring
    provider: sentry
    factory: oneiric.adapters.monitoring.sentry:SentryAdapter
    stack_level: 20
    version: "1.0.0"

    capabilities: ["error-tracking", "performance-monitoring", "release-tracking"]
    owner: "Observability Team"
    requires_secrets: true
    settings_model: "oneiric.adapters.monitoring.sentry:SentrySettings"

    requires:
      - "sentry-sdk>=2.0.0"

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/adapters/monitoring/sentry"

    metadata:
      description: "Sentry error and performance monitoring"
      traces_sample_rate: 0.1
      profiles_sample_rate: 0.1

  # ==============================================================================
  # ACTION EXAMPLES - Full metadata with action-specific fields
  # ==============================================================================

  # HTTP Fetch Action - Network action with retry policy
  - domain: action
    key: http.fetch
    provider: builtin-http-fetch
    factory: oneiric.actions.http:HttpFetchAction
    stack_level: 10
    version: "1.0.0"

    # Action-specific metadata
    side_effect_free: false  # Makes HTTP requests (side effect)
    timeout_seconds: 30.0
    retry_policy:
      attempts: 3
      base_delay: 0.5
      max_delay: 60.0
      jitter: 0.2
      retriable_status_codes: [429, 500, 502, 503, 504]

    requires:
      - "httpx>=0.27.0"

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/actions/http/fetch"

    metadata:
      description: "HTTP fetch with automatic retry and circuit breaker"
      supported_methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]

  # Workflow Audit Action - Stateless audit action
  - domain: action
    key: workflow.audit
    provider: builtin-workflow-audit
    factory: oneiric.actions.workflow:WorkflowAuditAction
    stack_level: 10
    version: "1.0.0"

    side_effect_free: true  # Pure audit logging (no side effects)
    timeout_seconds: 5.0

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/actions/workflow/audit"

    metadata:
      description: "Workflow audit logging with structured events"

  # Security Signature Action - Cryptographic action
  - domain: action
    key: security.signature
    provider: builtin-security-signature
    factory: oneiric.actions.security:SecuritySignatureAction
    stack_level: 10
    version: "1.0.0"

    side_effect_free: true  # Pure computation (deterministic)
    timeout_seconds: 10.0

    requires:
      - "cryptography>=42.0.0"

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/actions/security/signature"

    metadata:
      description: "HMAC signature generation and verification"
      supported_algorithms: ["sha256", "sha512", "blake3"]

  # Data Transform Action - Data processing with timeout
  - domain: action
    key: data.transform
    provider: builtin-data-transform
    factory: oneiric.actions.data:DataTransformAction
    stack_level: 10
    version: "1.0.0"

    side_effect_free: true  # Pure data transformation
    timeout_seconds: 60.0  # Longer timeout for large datasets

    requires:
      - "msgspec>=0.18.0"

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/actions/data/transform"

    metadata:
      description: "Declarative data transformation with field selectors"
      max_payload_size_mb: 10

  # Task Schedule Action - Long-running task scheduler
  - domain: action
    key: task.schedule
    provider: builtin-task-schedule
    factory: oneiric.actions.task:TaskScheduleAction
    stack_level: 10
    version: "1.0.0"

    side_effect_free: false  # Schedules tasks (side effect)
    timeout_seconds: 120.0
    retry_policy:
      attempts: 5
      base_delay: 0.5
      max_delay: 300.0
      jitter: 0.1

    python_version: ">=3.13"

    license: "MIT"
    documentation_url: "https://docs.oneiric.dev/actions/task/schedule"

    metadata:
      description: "Task scheduling with cron and interval patterns"
      supported_patterns: ["cron", "interval", "one-shot"]

  # ==============================================================================
  # SERVICE EXAMPLES - Domain-agnostic services
  # ==============================================================================

  - domain: service
    key: payment-processor
    provider: stripe
    factory: example.services.payment:StripePaymentService
    stack_level: 20
    version: "1.0.0"

    capabilities: ["charge", "refund", "subscription"]
    owner: "Payments Team"
    requires_secrets: true

    requires:
      - "stripe>=9.0.0"

    python_version: ">=3.13"

    license: "Proprietary"
    documentation_url: "https://internal.example.com/services/payment"

    metadata:
      description: "Stripe payment processing service"
      api_version: "2024-11-20"

  # ==============================================================================
  # TASK & EVENT EXAMPLES - Minimal examples
  # ==============================================================================

  - domain: task
    key: email-sender
    provider: sendgrid
    factory: example.tasks.email:SendGridEmailTask
    stack_level: 10
    version: "1.0.0"

    side_effect_free: false
    timeout_seconds: 30.0
    retry_policy:
      attempts: 3
      base_delay: 0.5
      max_delay: 5.0
      jitter: 0.1

    requires:
      - "sendgrid>=6.11.0"

    metadata:
      description: "Email sending via SendGrid"
  - domain: task
    key: extract-task
    provider: dag-worker
    factory: example.tasks.pipeline:ExtractStage
    stack_level: 10
    version: "1.0.0"

    metadata:
      description: "Pipeline extract stage"
  - domain: task
    key: load-task
    provider: dag-worker
    factory: example.tasks.pipeline:LoadStage
    stack_level: 10
    version: "1.0.0"

    metadata:
      description: "Pipeline load stage"

  - domain: event
    key: webhook.dispatch
    provider: http-webhook
    factory: example.events.webhook:HttpWebhookHandler
    stack_level: 10
    version: "1.0.0"

    side_effect_free: false
    timeout_seconds: 60.0

    event_topics:
      - webhook.received
      - webhook.retry
    event_max_concurrency: 10
    event_filters:
      - path: payload.account_region
        any_of: ["us", "ca"]
      - path: headers.trace_id
        exists: true
    event_priority: 75
    event_fanout_policy: exclusive
    retry_policy:
      attempts: 3
      base_delay: 0.25
      max_delay: 3.0
      jitter: 0.1

    metadata:
      description: "HTTP webhook dispatcher with concurrent delivery"

  # ==============================================================================
  # WORKFLOW EXAMPLE - Orchestration
  # ==============================================================================

  - domain: workflow
    key: data-pipeline
    provider: orchestrator
    factory: example.workflows.pipeline:DataPipelineWorkflow
    stack_level: 10
    version: "1.0.0"

    side_effect_free: false
    timeout_seconds: 3600.0  # 1 hour for long-running pipeline

    capabilities: ["dag-execution", "checkpointing", "rollback"]

    metadata:
      description: "Multi-stage data processing pipeline"
      max_parallel_stages: 5
      scheduler:
        queue_category: queue.scheduler
        provider: cloudtasks
    dag:
      nodes:
        - id: extract
          task: extract-task
          retry_policy:
            attempts: 3
            base_delay: 0.2
            max_delay: 2.0
            jitter: 0.1
        - id: load
          task: load-task
          depends_on: ["extract"]
          retry_policy:
            attempts: 2
            base_delay: 0.1
            max_delay: 1.0
            jitter: 0.05
