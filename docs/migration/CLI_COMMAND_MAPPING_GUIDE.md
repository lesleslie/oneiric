# MCP Server CLI Command Mapping Guide

**Status:** üü° DRAFT  
**Created:** 2025-12-30  
**Last Updated:** 2025-12-30  
**Purpose:** Standardize CLI commands across all MCP servers using Oneiric patterns

---

## üéØ Executive Summary

This guide documents the migration from legacy CLI patterns to standardized Oneiric CLI commands across all 5 MCP server projects. The goal is to provide consistent lifecycle management, health checking, and observability for all MCP servers.

### Migration Principles

1. **Consistency:** All MCP servers use identical CLI command structure
2. **Oneiric Standard:** Follow Oneiric CLI factory patterns
3. **No Legacy Support:** Remove all legacy CLI flags and patterns
4. **Health First:** Prioritize health and status reporting
5. **Instance Isolation:** Support `--instance-id` for multi-instance deployments

---

## üìã Standard CLI Command Reference

### Oneiric CLI Factory Standard Commands

All MCP servers must implement these commands using `MCPServerCLIFactory`:

| Command | Description | Required | Notes |
|---------|-------------|----------|-------|
| `start` | Start the MCP server | ‚úÖ Yes | Writes PID file, initializes runtime snapshots |
| `stop` | Stop the running server | ‚úÖ Yes | Reads PID file, graceful shutdown |
| `restart` | Restart the server | ‚úÖ Yes | Stop + Start sequence |
| `status` | Show server status | ‚úÖ Yes | Reads runtime snapshots + PID |
| `health` | Health check endpoint | ‚úÖ Yes | Reads cached health snapshot |
| `health --probe` | Live health probe | ‚úÖ Yes | Performs live health checks |

### Optional Commands (Project-Specific)

| Command | Description | Required | Notes |
|---------|-------------|----------|-------|
| `config show` | Display current configuration | ‚ùå No | Use Oneiric config patterns |
| `config validate` | Validate configuration | ‚ùå No | Use Pydantic validation |
| `version` | Show version information | ‚ùå No | Use `--version` flag |
| `help` | Show help information | ‚ùå No | Auto-generated by CLI factory |

---

## üîÑ Project-Specific CLI Migrations

### 1. mailgun-mcp Migration

**Current State:**
- No explicit CLI entry point
- Runs via: `python -m mailgun_mcp` (but no __main__.py)
- Uses FastMCP's built-in server startup
- No direct CLI commands

**Target State:**
```bash
# New Oneiric CLI commands
mailgun-mcp start
mailgun-mcp stop
mailgun-mcp restart
mailgun-mcp status
mailgun-mcp health
mailgun-mcp health --probe

# Optional commands
mailgun-mcp config show
mailgun-mcp --version
mailgun-mcp --help
```

**Migration Steps:**
1. ‚úÖ Create `mailgun_mcp/__main__.py` with CLI factory
2. ‚úÖ Add console script entry point in `pyproject.toml`
3. ‚úÖ Implement `MailgunMCPServer` with Oneiric lifecycle
4. ‚úÖ Add health check endpoints
5. ‚úÖ Implement runtime snapshot management
6. ‚úÖ Remove all legacy CLI patterns

**Implementation Example:**
```python
# mailgun_mcp/__main__.py
from oneiric.core.cli import MCPServerCLIFactory
from mailgun_mcp.server import MailgunMCPServer
from mailgun_mcp.config import MailgunConfig

def main():
    cli_factory = MCPServerCLIFactory(
        server_class=MailgunMCPServer,
        config_class=MailgunConfig,
        name="mailgun-mcp",
        description="Mailgun Email MCP Server",
        version="1.0.0"
    )
    cli_factory.run()

if __name__ == "__main__":
    main()
```

---

### 2. unifi-mcp Migration

**Current State:**
- No explicit CLI entry point  
- Runs via: `python -m unifi_mcp`
- Uses FastMCP's built-in server startup
- No direct CLI commands

**Target State:**
```bash
# New Oneiric CLI commands
unifi-mcp start
unifi-mcp stop
unifi-mcp restart
unifi-mcp status
unifi-mcp health
unifi-mcp health --probe

# Optional commands
unifi-mcp config show
unifi-mcp --version
unifi-mcp --help
```

**Migration Steps:**
1. ‚è≥ Create `unifi_mcp/__main__.py` with CLI factory
2. ‚è≥ Add console script entry point in `pyproject.toml`
3. ‚è≥ Implement `UniFiMCPServer` with Oneiric lifecycle
4. ‚è≥ Add health check endpoints
5. ‚è≥ Implement runtime snapshot management
6. ‚è≥ Remove all legacy CLI patterns

---

### 3. opera-cloud-mcp Migration

**Current State:**
- Has console script entry point: `opera-cloud-mcp`
- Uses FastMCP's built-in server startup
- No explicit CLI commands
- Configuration via environment variables

**Target State:**
```bash
# New Oneiric CLI commands
opera-cloud-mcp start
opera-cloud-mcp stop
opera-cloud-mcp restart
opera-cloud-mcp status
opera-cloud-mcp health
opera-cloud-mcp health --probe

# Optional commands
opera-cloud-mcp config show
opera-cloud-mcp --version
opera-cloud-mcp --help
```

**Migration Steps:**
1. ‚è≥ Update `opera_cloud_mcp/__main__.py` with CLI factory
2. ‚è≥ Modify console script entry point
3. ‚è≥ Implement `OperaCloudMCPServer` with Oneiric lifecycle
4. ‚è≥ Add health check endpoints
5. ‚è≥ Implement runtime snapshot management
6. ‚è≥ Remove all legacy CLI patterns

**Special Considerations:**
- Handle SQLModel integration with Oneiric
- Preserve existing console script name
- Maintain backward compatibility during transition

---

### 4. raindropio-mcp Migration

**Current State:**
- Has console script entry point: `raindropio-mcp`
- Uses FastMCP's built-in server startup
- No explicit CLI commands
- Simple configuration

**Target State:**
```bash
# New Oneiric CLI commands
raindropio-mcp start
raindropio-mcp stop
raindropio-mcp restart
raindropio-mcp status
raindropio-mcp health
raindropio-mcp health --probe

# Optional commands
raindropio-mcp config show
raindropio-mcp --version
raindropio-mcp --help
```

**Migration Steps:**
1. ‚è≥ Update `raindropio_mcp/__main__.py` with CLI factory
2. ‚è≥ Modify console script entry point
3. ‚è≥ Implement `RaindropMCPServer` with Oneiric lifecycle
4. ‚è≥ Add health check endpoints
5. ‚è≥ Implement runtime snapshot management
6. ‚è≥ Remove all legacy CLI patterns

---

### 5. excalidraw-mcp Migration (Special Case)

**Current State:**
- Node.js/TypeScript project
- Custom CLI commands: `npm run canvas`, `npm run dev`
- WebSocket-based real-time server
- No FastMCP dependency

**Target State (Option 1 - Python Rewrite):**
```bash
# New Oneiric CLI commands
excalidraw-mcp start
excalidraw-mcp stop
excalidraw-mcp restart
excalidraw-mcp status
excalidraw-mcp health
excalidraw-mcp health --probe

# Optional commands
excalidraw-mcp config show
excalidraw-mcp --version
excalidraw-mcp --help
```

**Target State (Option 2 - Node.js Adapter):**
```bash
# New Oneiric CLI commands (Node.js implementation)
excalidraw-mcp start
excalidraw-mcp stop
excalidraw-mcp restart
excalidraw-mcp status
excalidraw-mcp health
excalidraw-mcp health --probe

# Optional commands
excalidraw-mcp config show
excalidraw-mcp --version
excalidraw-mcp --help
```

**Migration Steps (Decision Pending):**
1. ‚è≥ Complete architecture analysis
2. ‚è≥ Make migration approach decision (Python rewrite vs Node.js adapter)
3. ‚è≥ Implement chosen approach
4. ‚è≥ Add Oneiric CLI factory (Python or Node.js)
5. ‚è≥ Implement lifecycle management
6. ‚è≥ Add health check endpoints
7. ‚è≥ Implement runtime snapshot management
8. ‚è≥ Preserve WebSocket functionality
9. ‚è≥ Update frontend integration

**Special Considerations:**
- WebSocket real-time functionality must be preserved
- Frontend integration may need updates
- Performance considerations for canvas sync
- Node.js ‚Üî Oneiric bridge complexity

---

## üîß Technical Implementation Guide

### Oneiric CLI Factory Integration

**Standard Pattern:**
```python
# project/__main__.py
from oneiric.core.cli import MCPServerCLIFactory
from project.server import ProjectMCPServer
from project.config import ProjectConfig

def create_cli():
    return MCPServerCLIFactory(
        server_class=ProjectMCPServer,
        config_class=ProjectConfig,
        name="project-mcp",
        description="Project MCP Server",
        version="1.0.0",
        # Optional: custom commands
        additional_commands={
            "config": {
                "show": "Display current configuration",
                "validate": "Validate configuration"
            }
        }
    )

if __name__ == "__main__":
    create_cli().run()
```

### Server Class Implementation

**Standard Server Pattern:**
```python
# project/server.py
from oneiric.core.server import OneiricMCPServer
from project.config import ProjectConfig

class ProjectMCPServer(OneiricMCPServer):
    def __init__(self, config: ProjectConfig):
        super().__init__(config)
        # Project-specific initialization

    async def on_startup(self):
        await super().on_startup()
        # Project-specific startup logic

    async def on_shutdown(self):
        # Project-specific cleanup
        await super().on_shutdown()

    async def health_check(self) -> dict:
        base_health = await super().health_check()
        project_health = {
            "api_connection": self.check_api_connection(),
            "cache_status": self.check_cache_status()
        }
        return {**base_health, **project_health}
```

### Configuration Class Implementation

**Standard Configuration Pattern:**
```python
# project/config.py
from oneiric.core.config import OneiricMCPConfig
from pydantic import Field

class ProjectConfig(OneiricMCPConfig):
    # Standard Oneiric fields
    http_port: int = Field(default=3039, env="PROJECT_HTTP_PORT")
    http_host: str = Field(default="127.0.0.1", env="PROJECT_HTTP_HOST")
    enable_telemetry: bool = Field(default=True, env="PROJECT_ENABLE_TELEMETRY")

    # Project-specific fields
    api_key: str = Field(..., env="PROJECT_API_KEY")
    api_secret: str = Field(..., env="PROJECT_API_SECRET")

    class Config:
        env_prefix = "PROJECT_"
        env_file = ".env.project"
```

### Console Script Entry Point

**pyproject.toml Configuration:**
```toml
[project.scripts]
project-mcp = "project.__main__:main"
```

### Runtime Cache Management

**Standard Cache Structure:**
```
.oneiric_cache/
‚îú‚îÄ‚îÄ server.pid                  # PID file (current instance)
‚îú‚îÄ‚îÄ runtime_health.json         # Health snapshot
‚îú‚îÄ‚îÄ runtime_telemetry.json      # Telemetry data
‚îî‚îÄ‚îÄ instance-1/                 # Multi-instance support
    ‚îú‚îÄ‚îÄ server.pid
    ‚îú‚îÄ‚îÄ runtime_health.json
    ‚îî‚îÄ‚îÄ runtime_telemetry.json
```

**Cache File Contents:**

`runtime_health.json`:
```json
{
  "status": "HEALTHY",
  "components": [
    {
      "name": "api_connection",
      "status": "HEALTHY",
      "message": "API connection established",
      "latency_ms": 120,
      "metadata": {}
    },
    {
      "name": "http_client",
      "status": "HEALTHY",
      "message": "HTTP client operational",
      "latency_ms": 50,
      "metadata": {}
    }
  ],
  "timestamp": "2025-12-30T12:00:00Z"
}
```

`runtime_telemetry.json`:
```json
{
  "metrics": {
    "requests_processed": 42,
    "errors_encountered": 0,
    "average_response_time_ms": 120,
    "uptime_seconds": 3600
  },
  "timestamp": "2025-12-30T12:00:00Z"
}
```

---

## üõ°Ô∏è Compatibility Contract

### CLI Command Contract (Crackerjack Standard)

**Mandatory Requirements:**
1. **Command Structure:** Use subcommand syntax (`start`, `stop`, etc.)
2. **No Legacy Flags:** Remove all legacy `--start`, `--stop` flags
3. **Instance Isolation:** Support `--instance-id <id>` for multi-instance
4. **Exit Codes:** Follow standard exit codes (0=success, 1=error)
5. **Help Output:** Auto-generated by CLI factory

**Command Semantics:**
- `start`: Start server, write PID file, initialize snapshots
- `stop`: Stop server gracefully, remove PID file
- `restart`: Stop + Start sequence
- `status`: Read PID + runtime snapshots
- `health`: Read cached health snapshot
- `health --probe`: Perform live health checks

### Runtime Cache Contract

**Mandatory Requirements:**
1. **Cache Location:** `.oneiric_cache/` (default instance)
2. **Multi-instance:** `.oneiric_cache/<instance-id>/`
3. **PID File:** `server.pid` with process ID
4. **Health Snapshot:** `runtime_health.json` with mcp-common schema
5. **Telemetry:** `runtime_telemetry.json` with metrics

### Health Schema Contract (Session-Buddy)

**Mandatory Schema:**
```python
from mcp_common.health import HealthStatus, ComponentHealth, HealthCheckResponse

HealthCheckResponse(
    status=HealthStatus.HEALTHY,  # HEALTHY|DEGRADED|UNHEALTHY
    components=[
        ComponentHealth(
            name="component_name",
            status=HealthStatus.HEALTHY,
            message="Human-readable status",
            latency_ms=120,  # Optional
            metadata={...}    # Optional
        )
    ],
    timestamp="ISO_8601_datetime"
)
```

---

## üß™ Testing Requirements

### CLI Command Testing

**Test Coverage Requirements:**
- ‚úÖ `start` command functionality
- ‚úÖ `stop` command functionality  
- ‚úÖ `restart` command functionality
- ‚úÖ `status` command output
- ‚úÖ `health` command output
- ‚úÖ `health --probe` live checks
- ‚úÖ Error handling and exit codes
- ‚úÖ Instance isolation (`--instance-id`)

**Test Examples:**
```python
# Test CLI commands
import subprocess
import json

def test_start_command():
    result = subprocess.run(["project-mcp", "start"], capture_output=True, text=True)
    assert result.returncode == 0
    assert "Server started" in result.stdout
    # Verify PID file created
    assert os.path.exists(".oneiric_cache/server.pid")

def test_status_command():
    result = subprocess.run(["project-mcp", "status"], capture_output=True, text=True)
    assert result.returncode == 0
    status_data = json.loads(result.stdout)
    assert "status" in status_data
    assert "pid" in status_data

def test_health_command():
    result = subprocess.run(["project-mcp", "health"], capture_output=True, text=True)
    assert result.returncode == 0
    health_data = json.loads(result.stdout)
    assert "status" in health_data
    assert "components" in health_data

def test_health_probe_command():
    result = subprocess.run(["project-mcp", "health", "--probe"], capture_output=True, text=True)
    assert result.returncode == 0
    health_data = json.loads(result.stdout)
    assert "status" in health_data
    assert health_data["status"] in ["HEALTHY", "DEGRADED", "UNHEALTHY"]
```

### Runtime Cache Testing

**Test Coverage Requirements:**
- ‚úÖ PID file creation and management
- ‚úÖ Health snapshot creation
- ‚úÖ Telemetry data collection
- ‚úÖ Multi-instance isolation
- ‚úÖ Cache file validation

---

## üìã Migration Checklist

### Per-Project Migration Tasks

- [ ] ‚úÖ Create CLI command mapping guide (this document)
- [ ] ‚è≥ Implement Oneiric CLI factory
- [ ] ‚è≥ Create server class with lifecycle hooks
- [ ] ‚è≥ Implement configuration class
- [ ] ‚è≥ Add console script entry point
- [ ] ‚è≥ Implement health check endpoints
- [ ] ‚è≥ Add runtime cache management
- [ ] ‚è≥ Remove legacy CLI patterns
- [ ] ‚è≥ Update documentation
- [ ] ‚è≥ Create user migration guide
- [ ] ‚è≥ Test all CLI commands
- [ ] ‚è≥ Validate compatibility contract

### Cross-Project Standardization

- [ ] ‚è≥ Standardize CLI command structure
- [ ] ‚è≥ Standardize health schema
- [ ] ‚è≥ Standardize runtime cache
- [ ] ‚è≥ Standardize configuration patterns
- [ ] ‚è≥ Standardize error handling
- [ ] ‚è≥ Standardize logging

---

## üö® Risk Assessment & Mitigation

### High Risk Areas

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| **CLI Command Changes** | HIGH | HIGH | Clear documentation, migration guides |
| **ACB Removal** | HIGH | MEDIUM | Incremental removal, thorough testing |
| **Configuration Changes** | MEDIUM | HIGH | Backward compatibility, validation |
| **Performance Regression** | MEDIUM | MEDIUM | Benchmark before/after, optimization |
| **User Adoption** | MEDIUM | LOW | Clear communication, support channels |

### Mitigation Strategies

1. **Feature Flags:** Not used for legacy support (Oneiric-only)
2. **Rollback Procedures:** Tested rollback for each project
3. **Incremental Testing:** Test each command individually
4. **User Communication:** Clear migration guides and examples
5. **Performance Monitoring:** Benchmark critical operations

---

## ‚úÖ Success Criteria

### Technical Success Metrics

- [ ] ‚úÖ All projects use Oneiric CLI factory
- [ ] ‚úÖ Standardized command structure across all projects
- [ ] ‚úÖ Health schema compliance (mcp-common.health)
- [ ] ‚úÖ Runtime cache implementation
- [ ] ‚úÖ Instance isolation support
- [ ] ‚úÖ Zero legacy CLI patterns
- [ ] ‚úÖ Comprehensive test coverage
- [ ] ‚úÖ Performance metrics maintained

### User Success Metrics

- [ ] ‚úÖ Clear CLI command mapping documentation
- [ ] ‚úÖ Migration guides for each project
- [ ] ‚úÖ Configuration examples provided
- [ ] ‚úÖ Rollback procedures documented
- [ ] ‚úÖ Support channels established
- [ ] ‚úÖ User communication plan executed

---

## üìÖ Migration Timeline

### CLI Migration Schedule

| Project | CLI Migration Start | Target Completion |
|---------|---------------------|-------------------|
| mailgun-mcp | 2026-01-04 | 2026-01-10 |
| unifi-mcp | 2026-01-11 | 2026-01-17 |
| opera-cloud-mcp | 2026-01-18 | 2026-01-24 |
| raindropio-mcp | 2026-01-25 | 2026-01-31 |
| excalidraw-mcp | 2026-02-01 | 2026-02-14 |

### Testing Schedule

| Phase | Duration | Focus |
|-------|----------|-------|
| Unit Testing | 1 week | Individual command testing |
| Integration Testing | 1 week | Cross-project compatibility |
| Performance Testing | 1 week | Benchmark and optimization |
| User Testing | 1 week | Beta testing and feedback |

---

## üìù References

### Oneiric Documentation
- **CLI Patterns:** `oneiric/core/cli.py`
- **Server Patterns:** `oneiric/core/server.py`
- **Configuration:** `oneiric/core/config.py`
- **Health Patterns:** `oneiric/core/health.py`

### Compatibility References
- **Crackerjack CLI Contract:** `crackerjack/docs/reference/BREAKING_CHANGES.md`
- **Session-Buddy Health:** `session-buddy/docs/reference/API_REFERENCE.md`
- **MCP-Common Health:** `mcp-common/health.py`

### Migration References
- **Migration Plan:** `MCP_SERVER_MIGRATION_PLAN.md`
- **Tracking Dashboard:** `MIGRATION_TRACKING_DASHBOARD.md`
- **Checklist Template:** `MIGRATION_CHECKLIST_TEMPLATE.md`

---

## üéØ Next Steps

### Immediate Actions

1. **Complete CLI Mapping:**
   - [ ] ‚úÖ Document mailgun-mcp CLI mapping
   - [ ] ‚è≥ Document unifi-mcp CLI mapping
   - [ ] ‚è≥ Document opera-cloud-mcp CLI mapping
   - [ ] ‚è≥ Document raindropio-mcp CLI mapping
   - [ ] ‚è≥ Document excalidraw-mcp CLI mapping

2. **Begin Implementation:**
   - [ ] ‚è≥ Start with mailgun-mcp (simplest)
   - [ ] ‚è≥ Create Oneiric CLI factory
   - [ ] ‚è≥ Implement server class
   - [ ] ‚è≥ Add health endpoints

3. **Testing Preparation:**
   - [ ] ‚è≥ Create CLI test suite
   - [ ] ‚è≥ Define test coverage requirements
   - [ ] ‚è≥ Set up test environments

### Long-Term Actions

1. **Standardization:**
   - [ ] ‚è≥ Ensure consistent CLI patterns across projects
   - [ ] ‚è≥ Validate compatibility contract compliance
   - [ ] ‚è≥ Review health schema implementations

2. **Documentation:**
   - [ ] ‚è≥ Create user migration guides
   - [ ] ‚è≥ Update README files
   - [ ] ‚è≥ Add CLI examples and tutorials

3. **Rollout:**
   - [ ] ‚è≥ Plan rollout sequence
   - [ ] ‚è≥ Prepare communication materials
   - [ ] ‚è≥ Set up support channels

---

**Guide Status:** üü° ACTIVE  
**Last Updated:** 2025-12-30  
**Next Review:** 2026-01-01  
**Owner:** [Your Name]  
**Review Frequency:** Weekly during migration